<!DOCTYPE HTML>

<html>
	<head>
		<title>Tufts Marauder's Map</title>
		<meta charset="utf-8" />
		<link rel="stylesheet" href="style.css"/>
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBGvUJlso3Vyw_1J4CpBvob7RowMWQssvk"></script>
	    <script type="text/javascript">
	    	global_login = "Dipstick"
	    	crd = null;
		    
		    function initialize() {
		        var mapOptions = {
		          center: { lat: 42.358431, lng: -71.059773},
		          zoom: 8
		        };

		        // Global Google map
		        map = new google.maps.Map(document.getElementById('map-canvas'),
		            mapOptions);

		        navigator.geolocation.getCurrentPosition(set_markers, error);		        
	  	    }

		    function set_markers(pos) {
			  crd = pos.coords;
			  var image_me = "pictures/gandolf_50_50.jpg";
			  var current_date = new Date();
			  var date_time = (current_date.getMonth()+1)  + "/"  +
						    	current_date.getDate() + "/" +
			                	current_date.getFullYear() + " @ "  +
			                	current_date.getHours() + ":"  +
			                	current_date.getMinutes() + ":" +
			                	current_date.getSeconds();
			  var contentString_me = '<h1>Me</h1>' + 
			  							'<div id="contentString">' +
			  							'<p>Latitude: ' + crd.latitude + ' Longitude: ' + crd.longitude +
			  							'</br>Last Seen: ' + date_time + '</p>';
			  var marker_me = new google.maps.Marker({
			  	position: new google.maps.LatLng(crd.latitude, crd.longitude),
			  	map: map,
			  	title: "Me!",
			  	icon: image_me
			  });

			  var infowindow_me = new google.maps.InfoWindow({
		    	content: contentString_me
			  });
			  google.maps.event.addDomListener(marker_me, 'click', function () {infowindow_me.open(map, marker_me);});
			  find_others();
			}

			function error(err) {
			  var output = document.getElementById("map-canvas");

			  output.innerHTML = "Unable to retrieve your location"; 
			}
		   
	 		function find_others() {
	 			xhr = new XMLHttpRequest();
	 			xhr.open("POST", "http://chickenofthesea.herokuapp.com/sendLocation", true);
		        xhr.onreadystatechange = dataReady;
		        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		        xhr.send("login=" + global_login + "&lat=" + crd.latitude + "&lng=" + crd.longitude);
	 		}
			
			function dataReady() {
		      	if (xhr.readyState == 4 && xhr.status == 200) {
		      		alert("xhr: " + xhr.responseText);
		      	}
		   		else if (xhr.readyState == 4 && xhr.status == 500) {
		   			alert("failed");
		   		}
		    }
		    
		    google.maps.event.addDomListener(window, 'load', initialize);
	    </script>
	</head>

	<body>
		<div id="map-canvas">loading map...</div>
	</body>
	
</html>