<!DOCTYPE HTML>

<html>
	<head>
		<title>Tufts Marauder's Map</title>
		<meta charset="utf-8" />
		<link rel="stylesheet" href="style.css"/>
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBGvUJlso3Vyw_1J4CpBvob7RowMWQssvk"></script>
	    <script type="text/javascript">
	    	const GLOBAL_LOGIN = "Dipstick"
	    	const IMAGES = {me: "pictures/gandolf_50_50.jpg", 
	    					carmen: "pictures/carmen_50_50.png", 
	    					waldo: "pictures/waldo_50_60.png", 
	    					batman: "pictures/batman_50_50.png", 
	    					nr: "pictures/nr_50_50.png", 
	    					snape: "pictures/snape_50_50.png", 
	    					hescott: "pictures/hescott_50_69.png"};
	    	const PRECISION = 4; //floating point number precision
	    	crd = null;
		    
		    function initialize() {
		        var mapOptions = {
		          center: { lat: 42.358431, lng: -71.059773},
		          zoom: 11
		        };

		        // Global Google map
		        map = new google.maps.Map(document.getElementById('map-canvas'),
		            mapOptions);

		        navigator.geolocation.getCurrentPosition(set_markers, error);		        
	  	    }

		    function set_markers(pos) {
			  crd = pos.coords;
			  var current_date = new Date();
			  var date_time = (current_date.getMonth()+1)  + "/"  +
						    	current_date.getDate() + "/" +
			                	current_date.getFullYear() + " @ "  +
			                	current_date.getHours() + ":"  +
			                	current_date.getMinutes() + ":" +
			                	current_date.getSeconds();
			  var content_string_me = '<h1>Me</h1>' + 
			  							'<div id="contentString">' +
			  							'<p>Latitude: ' + 
			  							crd.latitude.toFixed(PRECISION) + 
			  							' Longitude: ' + 
			  							crd.longitude.toFixed(PRECISION) +
			  							'</br>Last Seen: ' + date_time + '</p>';
			  var marker_me = new google.maps.Marker({
			  	position: new google.maps.LatLng(crd.latitude, crd.longitude),
			  	map: map,
			  	title: "Me!",
			  	icon: IMAGES["me"]
			  });

			  var infowindow_me = new google.maps.InfoWindow({
		    	content: content_string_me,
			  });
			  google.maps.event.addDomListener(marker_me, 'click', function () {infowindow_me.open(map, marker_me);});
			  find_others();
			}

			function error(err) {
			  var output = document.getElementById("map-canvas");

			  output.innerHTML = "Unable to retrieve your location"; 
			}
		   
	 		function find_others() {
	 			xhr = new XMLHttpRequest();
	 			xhr.open("POST", "http://chickenofthesea.herokuapp.com/sendLocation", true);
		        xhr.onreadystatechange = dataReady;
		        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		        xhr.send("login=" + GLOBAL_LOGIN + "&lat=" + crd.latitude + 
		        												"&lng=" + 
		        												crd.longitude);
	 		}
			
			function dataReady() {
		      	if (xhr.readyState == 4 && xhr.status == 200) {
		      		console.log("xhr: " + xhr.responseText);
		      		add_markers(JSON.parse(xhr.responseText));
		      	}
		   		else if (xhr.readyState == 4 && xhr.status == 500) {
		   			alert("failed getting characters and students");
		   		}
		    }

		    function add_markers(json_data) {
		    	for (i = 0; i < json_data.characters.length; i++) {
		    		console.log("character name: " + json_data.characters[i].name);	
		    		plot_characters(json_data.characters[i].name, 
		    						 json_data.characters[i].loc.latitude,
		    						 json_data.characters[i].loc.longitude, 
		    						 json_data.characters[i].loc.note);
		    	}  
		      	
		    	for (i = 0; i < json_data.students.length; i++) {
		    		plot_students(json_data.students[i].login, 
		    						json_data.students[i].lat, 
		    						json_data.students[i].lng, 
		    						json_data.students[i].created_at);
		    	}

		    	function plot_students(login, lat, lng, time_seen) {
		    		var content_string_student = '<h1>' + login + '</h1>' + 
			  							'<div id="contentString">' +
			  							'<p>Latitude: ' + 
			  							lat.toFixed(PRECISION) + 
			  							' Longitude: ' + 
			  							lng.toFixed(PRECISION) +
			  							'</br>Last Seen: ' + time_seen + '</p>';
		    		var marker_student = new google.maps.Marker({
		    			position: new google.maps.LatLng(lat, lng),
		    			map: map,
		    			title: login
		    		});
					var infowindow_student = new google.maps.InfoWindow({
		    			content: content_string_student
			  		});

			  		google.maps.event.addDomListener(marker_student, 'click', function () {infowindow_student.open(map, marker_student);});
		    	};
	
		    	function plot_characters(name, lat, lng, note) {
		    		var content_string_character = '<h1>' + name + '</h1>' + 
			  							'<div id="contentString">' +
			  							'<p>Latitude: ' + 
			  							lat.toFixed(PRECISION) + 
			  							' Longitude: ' + 
			  							lng.toFixed(PRECISION) +
			  							'</br>Note: ' + note + '</p>';
		    		var marker_character = new google.maps.Marker({
		    			position: new google.maps.LatLng(lat, lng),
		    			map: map,
		    			title: name,
		    			icon: IMAGES[name]
		    		});

		    		var infowindow_character = new google.maps.InfoWindow({
		    			content: content_string_character
			  		});

			  		google.maps.event.addDomListener(marker_character, 'click', function () {infowindow_character.open(map, marker_character);});
		    	};
		    }
		    
		    google.maps.event.addDomListener(window, 'load', initialize);
	    </script>
	</head>

	<body>
		<div id="map-canvas">loading map...</div>
	</body>
	
</html>